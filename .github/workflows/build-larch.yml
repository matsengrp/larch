name: Build larch on linux and run tests

on:
  workflow_dispatch:

jobs:
  build-larch:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v2
        with:
          submodules: true
      - name: Prepare build environment
        run: |
          sudo apt-get update
          sudo apt-get install build-essential zlib1g-dev python3-pip python3-pytest git git-lfs
      - name: Set up Conda
        uses: conda-incubator/setup-miniconda@v2
        with:
          auto-activate-base: false
      - name: Create conda env
        run: |
          conda env create -f environment-dev.yml
      - name: Build (cmake step)
        run: |
          conda activate larch-dev
          cd build
          export CMAKE_NUM_THREADS="8"
          cmake -DCMAKE_BUILD_TYPE=Debug ..
      - name: Build (make step)
        run: |
          conda activate larch-dev
          cd build
          make -j8
          ln -s ../data
      - name: Run tests
        run: |
          conda activate larch-dev
          cd build
          ./larch-test -tag slow
